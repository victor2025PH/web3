# Ollama 服务启动说明

## 问题分析

根据截图分析：

1. **路径问题**：
   - `cloudflared.exe` 位于：`D:\Tunnel\cloudflared.exe`
   - 项目目录：`d:\web3-migration\aizkw20251219`

2. **错误原因**：
   - `ollama-cors-proxy.js` 使用了 `require`，但项目是 ES 模块
   - PowerShell 需要完整路径或 `.\cloudflared.exe` 来运行

## 正确的启动方法

### 方法 1：使用批处理脚本（推荐）

#### 选项 A：一键启动（最简单）

双击运行：`一键启动Ollama服务.bat`

这会自动：
1. 检查 Ollama 服务
2. 启动 CORS 代理服务器（新窗口）
3. 启动 Cloudflare Tunnel（新窗口）

#### 选项 B：分步启动

**窗口 1** - 启动 CORS 代理：
```
双击运行: 启动Ollama代理.bat
```

**窗口 2** - 启动 Cloudflare Tunnel：
```
双击运行: 启动CloudflareTunnel.bat
```

### 方法 2：手动命令

#### 窗口 1：启动 CORS 代理服务器

在项目目录打开 PowerShell 或 CMD：

```powershell
cd d:\web3-migration\aizkw20251219
node ollama-cors-proxy.cjs
```

**保持此窗口打开！**

#### 窗口 2：启动 Cloudflare Tunnel

在 `D:\Tunnel` 目录打开 PowerShell 或 CMD：

```powershell
cd D:\Tunnel
.\cloudflared.exe tunnel --url http://localhost:3002
```

或者使用完整路径：

```powershell
D:\Tunnel\cloudflared.exe tunnel --url http://localhost:3002
```

**保持此窗口打开！**

等待显示 Tunnel URL，例如：
```
Your quick Tunnel has been created! Visit it at:
https://abc-xyz-123.trycloudflare.com
```

## 文件说明

- `ollama-cors-proxy.cjs` - CORS 代理服务器（已修复为 CommonJS 格式）
- `启动Ollama代理.bat` - 启动 CORS 代理的批处理脚本
- `启动CloudflareTunnel.bat` - 启动 Cloudflare Tunnel 的批处理脚本
- `一键启动Ollama服务.bat` - 一键启动所有服务的脚本

## 重要提示

1. **必须同时运行两个服务**：
   - CORS 代理服务器（端口 3002）
   - Cloudflare Tunnel

2. **关闭窗口会断开连接**：
   - 保持两个窗口都打开
   - 或者使用后台服务（PM2、Windows 服务）

3. **重启后需要重新运行**：
   - 临时 Tunnel URL 在重启后失效
   - 需要重新运行脚本获取新 URL

## 验证服务

### 检查 CORS 代理服务器

打开浏览器访问：`http://localhost:3002/health`

应该返回：
```json
{"status":"ok","ollama":"http://127.0.0.1:11434"}
```

### 检查 Cloudflare Tunnel

打开浏览器访问：`https://你的TunnelURL/health`

应该返回：
```json
{"status":"ok","ollama":"http://127.0.0.1:11434"}
```

## 更新配置

获取 Tunnel URL 后，编辑 `utils/ollamaProxy.ts`：

1. 第 8 行：
   ```typescript
   const OLLAMA_URL = 'https://你的新TunnelURL/api/chat';
   ```

2. 第 182 行：
   ```typescript
   const response = await fetch('https://你的新TunnelURL/api/tags', {
   ```

3. 重新构建并部署：
   ```powershell
   npm run build
   git add .
   git commit -m "Update Ollama Tunnel URL"
   git push origin main
   ```
