# AI 智控王 - 服务启动说明

## 快速启动

### 一键启动所有服务
双击运行：
```
一键启动所有服务.bat
```

这将自动启动 6 个窗口：
1. Ollama 服务
2. Ollama CORS 代理
3. Ollama Cloudflare Tunnel
4. GPT-SoVITS 服务
5. GPT-SoVITS CORS 代理
6. GPT-SoVITS Cloudflare Tunnel

### 停止所有服务
双击运行：
```
停止所有服务.bat
```

或手动关闭所有打开的窗口。

---

## 获取 Tunnel URL

启动后，需要从两个 Tunnel 窗口获取 URL：

### Ollama Tunnel URL
在 "Ollama Cloudflare Tunnel" 窗口中查找：
```
Your quick Tunnel has been created! Visit it at:
https://xxx-xxx-xxx.trycloudflare.com
```

### GPT-SoVITS Tunnel URL
在 "GPT-SoVITS Cloudflare Tunnel" 窗口中查找：
```
Your quick Tunnel has been created! Visit it at:
https://yyy-yyy-yyy.trycloudflare.com
```

---

## 更新配置文件

### 更新 Ollama URL
编辑 `utils/ollamaProxy.ts`，修改第 8 行：
```typescript
const OLLAMA_URL = 'https://你的Ollama-Tunnel-URL/api/chat';
```

### 更新 GPT-SoVITS URL
编辑 `src/voiceConfig.ts`，修改第 30 行：
```typescript
apiBaseUrl: 'https://你的GPT-SoVITS-Tunnel-URL',
```

---

## 重新部署

更新配置后，运行：
```powershell
cd d:\web3-migration
git add .
git commit -m "Update Tunnel URLs"
git push origin main
```

等待 GitHub Actions 完成部署。

---

## 手动启动（逐个启动）

如果一键启动失败，可以手动逐个启动：

### 窗口 1：Ollama 服务
```powershell
ollama serve
```

### 窗口 2：Ollama CORS 代理
```powershell
cd d:\web3-migration\aizkw20251219
node ollama-cors-proxy.cjs
```

### 窗口 3：Ollama Cloudflare Tunnel
```powershell
D:\Tunnel\cloudflared.exe tunnel --url http://localhost:3002
```

### 窗口 4：GPT-SoVITS 服务
```powershell
cd E:\GPT-SOVITS-v3lora-20250228
runtime\python.exe api_v2.py
```

### 窗口 5：GPT-SoVITS CORS 代理
```powershell
cd d:\web3-migration\aizkw20251219
node gpt-sovits-cors-proxy.cjs
```

### 窗口 6：GPT-SoVITS Cloudflare Tunnel
```powershell
D:\Tunnel\cloudflared.exe tunnel --url http://localhost:9881
```

---

## 服务架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         浏览器                                   │
└─────────────────────────────────────────────────────────────────┘
                    │                           │
                    ▼                           ▼
┌─────────────────────────┐     ┌─────────────────────────────────┐
│   Ollama Tunnel (URL1)  │     │   GPT-SoVITS Tunnel (URL2)      │
└─────────────────────────┘     └─────────────────────────────────┘
                    │                           │
                    ▼                           ▼
┌─────────────────────────┐     ┌─────────────────────────────────┐
│ Ollama CORS 代理 (3002) │     │ GPT-SoVITS CORS 代理 (9881)     │
└─────────────────────────┘     └─────────────────────────────────┘
                    │                           │
                    ▼                           ▼
┌─────────────────────────┐     ┌─────────────────────────────────┐
│   Ollama (11434)        │     │   GPT-SoVITS API (9880)         │
└─────────────────────────┘     └─────────────────────────────────┘
        AI 对话                         语音合成
```

---

## 常见问题

### Q: 窗口闪退怎么办？
A: 检查路径是否正确，特别是：
- GPT-SoVITS 路径：`E:\GPT-SOVITS-v3lora-20250228`
- Cloudflared 路径：`D:\Tunnel\cloudflared.exe`

### Q: Tunnel URL 每次都不一样？
A: 是的，临时 Tunnel 每次重启都会生成新 URL。每次重启后需要更新配置并重新部署。

### Q: 如何固定 Tunnel URL？
A: 需要注册 Cloudflare 账号并创建永久 Tunnel。详见 Cloudflare 文档。

### Q: 服务启动顺序重要吗？
A: 建议按脚本顺序启动，让服务有时间初始化。

---

## 端口说明

| 端口 | 服务 |
|------|------|
| 11434 | Ollama 本地服务 |
| 3002 | Ollama CORS 代理 |
| 9880 | GPT-SoVITS API |
| 9881 | GPT-SoVITS CORS 代理 |
